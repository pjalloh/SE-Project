
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OSM map with location search</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>

  <!-- Leaflet Control Geocoder (uses OpenStreetMap Nominatim by default) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
  />
  <script
    src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"
    defer
  ></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .leaflet-control-geocoder-form input {
      min-width: 260px; /* slightly wider search box */
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    window.addEventListener('load', () => {
      // 1) Create the map
      const map = L.map('map').setView([48.8566, 2.3522], 12); // Paris by default

      // 2) Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // 3) Add a single re-usable marker for search results
      let resultMarker = null;
      function showResult(latlng, label) {
        if (resultMarker) {
          resultMarker.setLatLng(latlng).setPopupContent(label);
        } else {
          resultMarker = L.marker(latlng).addTo(map).bindPopup(label);
        }
        resultMarker.openPopup();
      }

      // 4) Add the geocoder control (Nominatim-backed)
      //    - defaultMarkGeocode: false lets us control the marker/zoom ourselves
      const geocoder = L.Control.geocoder({
        defaultMarkGeocode: false,
        placeholder: 'Search for a placeâ€¦',
        errorMessage: 'Nothing found.'
      })
      .on('markgeocode', function(e) {
        const center = e.geocode.center;
        const name = e.geocode.name || 'Selected location';
        map.flyTo(center, Math.max(map.getZoom(), 15));
        showResult(center, name);
      })
      .addTo(map);

      // 5) Optional: click map to set/move marker and reverse-geocode (basic)
      map.on('click', async (ev) => {
        const { lat, lng } = ev.latlng;
        showResult(ev.latlng, `Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}`);
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`,
          {
            headers: { 'Accept-Language': navigator.language || 'en' }
          });
          const data = await res.json();
          if (data && data.display_name) {
            resultMarker.setPopupContent(data.display_name);
          }
        } catch (err) {
          console.warn('Reverse geocoding failed:', err);
        }
      });

      // Tip: For production use, add your own HTTP Referer/User-Agent.
      // Many hosted providers (e.g., OpenCage, LocationIQ, MapTiler) offer API keys,
      // higher rate limits, and SLAs. This demo keeps it keyless and simple.
    });
  </script>
</body>
</html>
