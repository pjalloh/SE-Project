<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Find stores & hotels (OSM Overpass + Leaflet)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="" defer></script>

  <!-- Leaflet Control Geocoder (Nominatim) for jumping to cities/addresses -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js" defer></script>

  <style>
    :root { --pad: 10px; }
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .toolbar {
      position: absolute; z-index: 1000; top: var(--pad); left: var(--pad);
      background: #fff; padding: 10px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,.15);
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .toolbar select, .toolbar button { height: 36px; border-radius: 8px; border: 1px solid #ddd; padding: 0 10px; }
    .toolbar button { background: #0b5; color: #fff; border-color: transparent; cursor: pointer; }
    .toolbar button:disabled { background: #ccc; cursor: not-allowed; }
    .results-counter { font-size: 13px; color: #333; margin-left: 6px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="toolbar">
    <label>
      Category
      <select id="category">
        <option value="hotels">Hotels</option>
        <option value="supermarkets">Supermarkets</option>
        <option value="restaurants">Restaurants</option>
        <option value="cafes">Cafés</option>
        <option value="pharmacies">Pharmacies</option>
        <option value="convenience">Convenience stores</option>
        <option value="clothes">Clothing stores</option>
      </select>
    </label>
    <button id="searchBtn">Search in map view</button>
    <span class="results-counter" id="counter"> </span>
  </div>

  <script>
    let map, markersLayer;

    function initMap() {
      map = L.map('map').setView([48.8566, 2.3522], 12); // Paris default

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);

      // Geocoder control to jump to a place
      L.Control.geocoder({
        defaultMarkGeocode: false,
        placeholder: 'Search address/city…'
      })
      .on('markgeocode', function(e) { map.fitBounds(e.geocode.bbox); })
      .addTo(map);

      document.getElementById('searchBtn').addEventListener('click', runSearch);
    }

    function bboxToOverpass(b) {
      const s = b.getSouth();
      const w = b.getWest();
      const n = b.getNorth();
      const e = b.getEast();
      return `${s},${w},${n},${e}`; // (south,west,north,east)
    }

    function buildQuery(category, bboxStr) {
      // Return Overpass QL for selected category within bbox
      // We query nodes/ways/relations and use `out center;` to get coordinates for areas.
      const parts = {
        hotels: `(
          node["tourism"="hotel"](${bboxStr});
          way["tourism"="hotel"](${bboxStr});
          relation["tourism"="hotel"](${bboxStr});
          node["tourism"="guest_house"](${bboxStr});
          way["tourism"="guest_house"](${bboxStr});
          relation["tourism"="guest_house"](${bboxStr});
        );`,
        supermarkets: `(
          node["shop"="supermarket"](${bboxStr});
          way["shop"="supermarket"](${bboxStr});
          relation["shop"="supermarket"](${bboxStr});
        );`,
        restaurants: `(
          node["amenity"="restaurant"](${bboxStr});
          way["amenity"="restaurant"](${bboxStr});
          relation["amenity"="restaurant"](${bboxStr});
        );`,
        cafes: `(
          node["amenity"="cafe"](${bboxStr});
          way["amenity"="cafe"](${bboxStr});
          relation["amenity"="cafe"](${bboxStr});
        );`,
        pharmacies: `(
          node["amenity"="pharmacy"](${bboxStr});
          way["amenity"="pharmacy"](${bboxStr});
          relation["amenity"="pharmacy"](${bboxStr});
        );`,
        convenience: `(
          node["shop"="convenience"](${bboxStr});
          way["shop"="convenience"](${bboxStr});
          relation["shop"="convenience"](${bboxStr});
        );`,
        clothes: `(
          node["shop"="clothes"](${bboxStr});
          way["shop"="clothes"](${bboxStr});
          relation["shop"="clothes"](${bboxStr});
        );`
      };

      const body = parts[category] || parts.hotels;
      return `
        [out:json][timeout:25];
        ${body}
        out center tags limit 500;`;
    }

    function elementToLatLng(el) {
      if (typeof el.lat === 'number' && typeof el.lon === 'number') return [el.lat, el.lon];
      if (el.center && typeof el.center.lat === 'number' && typeof el.center.lon === 'number') return [el.center.lat, el.center.lon];
      return null;
    }

    function tagsToPopup(tags) {
      const name = tags.name || 'Unnamed';
      const addr = [tags['addr:housenumber'], tags['addr:street'], tags['addr:city']].filter(Boolean).join(' ');
      const type = tags.amenity || tags.shop || tags.tourism || '';
      let html = `<strong>${name}</strong>`;
      if (addr) html += `<br>${addr}`;
      if (type) html += `<br><small>${type}</small>`;
      if (tags.website) html += `<br><a target="_blank" rel="noopener" href="${tags.website}">Website</a>`;
      if (tags.phone) html += `<br><small>${tags.phone}</small>`;
      return html;
    }

    async function runSearch() {
      const btn = document.getElementById('searchBtn');
      const cat = document.getElementById('category').value;
      const counter = document.getElementById('counter');
      btn.disabled = true; counter.textContent = 'Searching…';

      const bbox = bboxToOverpass(map.getBounds());
      const query = buildQuery(cat, bbox);
      const url = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);

      try {
        const res = await fetch(url, { headers: { 'Accept-Language': navigator.language || 'en' } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        markersLayer.clearLayers();
        let count = 0;
        data.elements.forEach(el => {
          const ll = elementToLatLng(el);
          if (!ll) return;
          const tagset = el.tags || {};
          L.marker(ll).addTo(markersLayer).bindPopup(tagsToPopup(tagset));
          count++;
        });
        counter.textContent = `${count} result${count === 1 ? '' : 's'}`;
        if (count > 0) {
          const group = L.featureGroup(markersLayer.getLayers());
          map.fitBounds(group.getBounds().pad(0.15), { maxZoom: 16 });
        }
      } catch (err) {
        console.error(err);
        counter.textContent = 'Error fetching results (try zooming in).';
      } finally {
        btn.disabled = false;
      }
    }

    window.addEventListener('load', initMap);
  </script>

  <!--
    Notes:
    • This demo queries the community Overpass endpoint. Respect rate limits: search smaller areas, avoid rapid repeat queries.
    • For heavier use, host your own Overpass instance or cache results server-side.
  -->
</body>
</html>
